(function(c){c.fn.tabby=function(e){var f=c.extend({},c.fn.tabby.defaults,e);var g=c.fn.tabby.pressed;return this.each(function(){$this=c(this);var h=c.meta?c.extend({},f,$this.data()):f;$this.bind("keydown",function(j){var i=c.fn.tabby.catch_kc(j);if(16===i){g.shft=true}if(17===i){g.ctrl=true;setTimeout(function(){c.fn.tabby.pressed.ctrl=false},1000)}if(18===i){g.alt=true;setTimeout(function(){c.fn.tabby.pressed.alt=false},1000)}if(9===i&&!g.ctrl&&!g.alt){j.preventDefault();g.last=i;setTimeout(function(){c.fn.tabby.pressed.last=null},0);d(c(j.target).get(0),g.shft,h);return false}}).bind("keyup",function(i){if(16===c.fn.tabby.catch_kc(i)){g.shft=false}}).bind("blur",function(i){if(9===g.last){c(i.target).one("focus",function(){g.last=null}).get(0).focus()}})})};c.fn.tabby.catch_kc=function(f){return f.keyCode?f.keyCode:f.charCode?f.charCode:f.which};c.fn.tabby.pressed={shft:false,ctrl:false,alt:false,last:null};function d(h,g,f){var e=h.scrollTop;if(h.setSelectionRange){a(h,g,f)}else{if(document.selection){b(h,g,f)}}h.scrollTop=e}c.fn.tabby.defaults={tabString:String.fromCharCode(9)};function a(g,e,s){var r=g.selectionStart;var p=g.selectionEnd;if(r===p){if(e){if(r-s.tabString===g.value.substring(r-s.tabString.length,r)){g.value=g.value.substring(0,r-s.tabString.length)+g.value.substring(r);g.focus();g.setSelectionRange(r-s.tabString.length,r-s.tabString.length)}else{if(r-s.tabString===g.value.substring(r,r+s.tabString.length)){g.value=g.value.substring(0,r)+g.value.substring(r+s.tabString.length);g.focus();g.setSelectionRange(r,r)}}}else{g.value=g.value.substring(0,r)+s.tabString+g.value.substring(r);g.focus();g.setSelectionRange(r+s.tabString.length,r+s.tabString.length)}}else{while(r<g.value.length&&g.value.charAt(r).match(/[ \t]/)){r++}var t=g.value.split("\n");var q=[];var j=0;var f=0;var l=0;for(l in t){f=j+t[l].length;q.push({start:j,end:f,selected:(j<=r&&f>r)||(f>=p&&j<p)||(j>r&&f<p)});j=f+1}var h=0;for(l in q){if(q[l].selected){var n=q[l].start+h;if(e&&s.tabString===g.value.substring(n,n+s.tabString.length)){g.value=g.value.substring(0,n)+g.value.substring(n+s.tabString.length);h-=s.tabString.length}else{if(!e){g.value=g.value.substring(0,n)+s.tabString+g.value.substring(n);h+=s.tabString.length}}}}g.focus();var m=r+((h>0)?s.tabString.length:(h<0)?-s.tabString.length:0);var k=p+h;g.setSelectionRange(m,k)}}function b(p,v,e){var n=document.selection.createRange();if(p===n.parentElement()){if(""===n.text){if(v){var k=n.getBookmark();n.moveStart("character",-e.tabString.length);if(e.tabString===n.text){n.text=""}else{n.moveToBookmark(k);n.moveEnd("character",e.tabString.length);if(e.tabString===n.text){n.text=""}}n.collapse(true);n.select()}else{n.text=e.tabString;n.collapse(false);n.select()}}else{var j=n.text;var m=j.length;var t=j.split("\r\n");var y=document.body.createTextRange();y.moveToElementText(p);y.setEndPoint("EndToStart",n);var l=y.text;var w=l.split("\r\n");var q=l.length;var x=document.body.createTextRange();x.moveToElementText(p);x.setEndPoint("StartToEnd",n);var u=x.text;var f=document.body.createTextRange();f.moveToElementText(p);f.setEndPoint("StartToEnd",y);var r=f.text;var g=c(p).html();c("#r3").text(q+" + "+m+" + "+u.length+" = "+g.length);if((q+r.length)<g.length){w.push("");q+=2;if(v&&e.tabString===t[0].substring(0,e.tabString.length)){t[0]=t[0].substring(e.tabString.length)}else{if(!v){t[0]=e.tabString+t[0]}}}else{if(v&&e.tabString===w[w.length-1].substring(0,e.tabString.length)){w[w.length-1]=w[w.length-1].substring(e.tabString.length)}else{if(!v){w[w.length-1]=e.tabString+w[w.length-1]}}}for(var s=1;s<t.length;s++){if(v&&e.tabString===t[s].substring(0,e.tabString.length)){t[s]=t[s].substring(e.tabString.length)}else{if(!v){t[s]=e.tabString+t[s]}}}if(1===w.length&&0===q){if(v&&e.tabString===t[0].substring(0,e.tabString.length)){t[0]=t[0].substring(e.tabString.length)}else{if(!v){t[0]=e.tabString+t[0]}}}if((q+m+u.length)<g.length){t.push("");m+=2}y.text=w.join("\r\n");n.text=t.join("\r\n");var h=document.body.createTextRange();h.moveToElementText(p);if(0<q){h.setEndPoint("StartToEnd",y)}else{h.setEndPoint("StartToStart",y)}h.setEndPoint("EndToEnd",n);h.select()}}}})(jQuery);